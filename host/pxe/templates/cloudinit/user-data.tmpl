#cloud-config
autoinstall:
  version: 1
{{- if and .Templates.Autoinstall.AdminUsername .Templates.Autoinstall.AdminPasswordHash }}
  identity:
    hostname: {{ .Identifiers.Hostname }}
    username: {{ default .Templates.Autoinstall.AdminUsername "ubuntu" }}
    password: {{ .Templates.Autoinstall.AdminPasswordHash }}
{{- else }}
  identity:
    hostname: {{ .Identifiers.Hostname }}
    username: ubuntu
    password: "$6$qwerty$kF9bfXlzx48SN7dbfq5dKvbPrdqOr0hIwwlqz6h0JPnmVdxmXaVb8cz91pcJn/qdNqxabWWMwBLT/gRghOA8p1"  # ubuntu
{{- end }}
  locale: {{ default .Templates.Common.Locale "en_US" }}
  timezone: {{ default .Templates.Common.Timezone "UTC" }}
  ssh:
    install-server: true
{{- if .Templates.Common.SSHAuthorizedKeys }}
    authorized-keys:
{{- range .Templates.Common.SSHAuthorizedKeys }}
      - {{ . }}
{{- end }}
{{- end }}
  keyboard:
    layout: {{ default .Templates.Common.KeyboardLayout "us" }}
    variant: '{{ .Templates.Common.KeyboardVariant }}'
{{- if .Templates.Common.Packages }}
  packages:
{{- range .Templates.Common.Packages }}
    - {{ . }}
{{- end }}
{{- end }}
{{- if .Templates.Common.Mirror }}
  apt:
    preserve_sources_list: false
    primary:
      - arches: [default]
        uri: {{ .Templates.Common.Mirror }}
{{- end }}
  storage:
    layout:
      name: direct
  user-data:
    disable_root: {{ if .Templates.Autoinstall.DisableRoot }}true{{ else }}false{{ end }}
{{- if or .Templates.Autoinstall.EarlyCommands .Templates.Autoinstall.PreScript }}
  early-commands:
{{- range .Templates.Autoinstall.EarlyCommands }}
    - {{ . }}
{{- end }}
{{- if .Templates.Autoinstall.PreScript }}
    - |
{{ indent 6 .Templates.Autoinstall.PreScript }}
{{- end }}
{{- end }}
{{- if or .Templates.Autoinstall.LateCommands .Templates.Autoinstall.PostScript }}
  late-commands:
{{- range .Templates.Autoinstall.LateCommands }}
    - {{ . }}
{{- end }}
{{- if .Templates.Autoinstall.PostScript }}
    - |
        curtin in-target -- /bin/bash -c '{{ .Templates.Autoinstall.PostScript | replace "'" "'\\''" }}'
{{- end }}
{{- end }}
