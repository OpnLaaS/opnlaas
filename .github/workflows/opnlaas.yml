name: OpnLaaS CI/CD
on:
  push:
    branches: [ "main" ]
permissions:
  contents: write
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node (for Tailwind v4 CLI)
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Write dummy config.toml
        run: |
          cat > config.toml <<'EOF'
          [web_server]
            address = ":8080"
            tls_dir = ""
            reload_templates_on_each_render = false
            redirect_server_addresses = []

          [ldap]
            address = "ldaps://ldap.example.com:636"
            domain_sld = "example"
            domain_tld = "com"
            accounts_cn = "accounts"
            users_cn = "users"
            groups_cn = "groups"
            admin_groups = ["admins"]
            user_groups = ["ipausers"]

            [management]
              username = "deskguest"
              password = "deskguest"
              [management.testing]
                [management.testing.basic]
                  enabled = false
                  ips = []
                [management.testing.long]
                  enabled = false
                  ip = ""

          [database]
            file = "laas.db"

          [proxmox]
            enabled = false
            hostname = ""
            port = ""
            token_id = ""
            secret = "laas-api-token-secret"
            [proxmox.testing]
              enabled = false
              subnet_cidr = "10.255.255.0/24"
              storage = "local-lvm"
              ubuntu_template = "local:vztmpl/ubuntu-22.04-standard_22.04-1_amd64.tar.zst"
              gateway = "10.0.0.1"
              dns = "10.0.0.2"
              search_domain = "local"

          [isos]
            search_dir = "./isos_search_dir"
            storage_dir = "./isos"
            testing = false

          [pxe]
            enabled = false
            [pxe.dhcp_server]
              address = ":67"
              interface = "eth0"
              server_public_address = "0.0.0.0"
              ip_range_start = "0.0.0.0"
              ip_range_end = "0.0.0.0"
              lease_seconds = 7200
              subnet_mask = "0.0.0.0"
              router = "0.0.0.0"
              dns_servers = ["0.0.0.0"]
            [pxe.tftp_server]
              address = ":69"
              directory = "/var/lib/tftpboot"
            [pxe.http_server]
              address = ":8069"
              directory = "/var/www/tftpboot"
              public_url = "http://laas.cyber.lab:8069"

          [preconfigure]
            locale = "en_US"
            timezone = "America/New_York"
            keyboard_layout = "us"
            keyboard_variant = ""
            packages = ["openssh-server"]
            mirror = ""
            root_password = ""
            disable_root = true
            global_kernel_params = []
            global_initrd_params = []
            [preconfigure.managed_user]
                username = "laas-admin"
                password = "laas-admin"
                allow_sudo = true
                ssh_authorized_keys = []
            [preconfigure.given_user]
                username = "laas"
                password = "laas"
                allow_sudo = true
                ssh_authorized_keys = []
            [preconfigure.scripting_file_paths]
                global_pre_script_file = ""
                global_post_script_file = ""
          EOF
      - name: Install Node deps
        run: |
          if [ -f package-lock.json ]; then
            echo "Using npm ci"
            npm ci
          else
            echo "package-lock.json not found; using npm i"
            npm i --no-audit --no-fund
          fi
      - name: Build Tailwind CSS and Webpack assets
        run: |
          npm run build
      - name: Go mod download
        run: go mod download
      - name: Run Go tests
        shell: bash
        run: |
          go test ./... -v
  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Prepare PXE host prerequisites
        run: |
          bash scripting/setup_host.sh || true
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Install Node deps
        run: |
          if [ -f package-lock.json ]; then
            echo "Using npm ci"
            npm ci
          else
            echo "package-lock.json not found; using npm i"
            npm i --no-audit --no-fund
          fi
      - name: Build Tailwind CSS and Webpack assets
        run: npm run build
      - name: Build Go binary (linux/amd64)
        run: |
          mkdir -p dist/linux-amd64
          GOOS=linux GOARCH=amd64 \
            go build -trimpath -ldflags="-s -w -X main.version=${{ github.sha }}" -o dist/linux-amd64/opnlaas .
      - name: Bundle runtime assets
        run: |
          mkdir -p dist/linux-amd64/public/static/styles
          mkdir -p dist/linux-amd64/public/views
          cp -r public/static dist/linux-amd64/public/
          cp -r public/views  dist/linux-amd64/public/
          cp README.md dist/linux-amd64/
          cp LICENSE   dist/linux-amd64/
          cp go.mod    dist/linux-amd64/
          cp scripting/setup_host.sh dist/linux-amd64/
      - name: Create tarball
        run: |
          tar -czf opnlaas-linux-amd64.tar.gz -C dist/linux-amd64 .
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-bundle
          path: opnlaas-linux-amd64.tar.gz
  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: release-bundle
          path: ./release
      - name: Create tag
        run: |
          TAG="ci-${{ github.run_number }}"
          echo "TAG=$TAG" >> $GITHUB_ENV
          git tag "$TAG" || true
          git push origin "$TAG" || true
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: "CI Release ${{ env.TAG }}"
          files: release/**
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
